name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ã‚³ãƒ¼ãƒ‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
    
    - name: å‹ãƒã‚§ãƒƒã‚¯
      run: npm run typecheck
    
    - name: ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
      run: npm run lint
    
    - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: npm test
    
    - name: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
      run: npm run build
    
    - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ç”Ÿæˆ
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "clean_version=${VERSION#v}" >> $GITHUB_OUTPUT
    
    - name: ãƒªãƒªãƒ¼ã‚¹ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
      run: |
        mkdir -p release
        
        # æœ¬ç•ªç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
        cp -r dist release/
        cp package.json release/
        cp package-lock.json release/
        cp .env.example release/
        cp README.md release/
        cp README-JP.md release/
        cp LICENSE release/ 2>/dev/null || echo "LICENSE file not found, skipping"
        
        # Scripts ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
        if [ -d "Scripts" ]; then
          cp -r Scripts release/
        fi
        
        # æœ¬ç•ªç”¨ package.json ã‚’èª¿æ•´ï¼ˆdevDependencies ã‚’é™¤å»ï¼‰
        cd release
        npm pkg delete devDependencies
        npm pkg set scripts.postinstall=""
        
        # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
        cd ..
        tar -czf "lol-patch-notifier-${{ steps.version.outputs.clean_version }}.tar.gz" -C release .
        zip -r "lol-patch-notifier-${{ steps.version.outputs.clean_version }}.zip" release/
    
    - name: ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ã‚’ç”Ÿæˆ
      id: changelog
      run: |
        if [ -f "CHANGELOG.md" ]; then
          # CHANGELOG.md ãŒã‚ã‚‹å ´åˆã€æœ€æ–°ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          CHANGELOG=$(awk '/^## \[/ {if (first) exit; first=1} first {print}' CHANGELOG.md | head -50)
        else
          # CHANGELOG.md ãŒãªã„å ´åˆã€Git ãƒ­ã‚°ã‹ã‚‰ç”Ÿæˆ
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%an)" ${PREVIOUS_TAG}..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%an)" --max-count=20)
          fi
        fi
        
        # GitHub Actions ã®ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "LoL Patch Notifier ${{ steps.version.outputs.version }}"
        body: |
          ## ğŸ® League of Legends Patch Notifier ${{ steps.version.outputs.version }}
          
          ### ğŸ“‹ å¤‰æ›´å†…å®¹
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          
          1. **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**
             ```bash
             # tar.gzå½¢å¼
             wget https://github.com/yuu1111/LoL-PatchNote-Notifier/releases/download/${{ steps.version.outputs.version }}/lol-patch-notifier-${{ steps.version.outputs.clean_version }}.tar.gz
             tar -xzf lol-patch-notifier-${{ steps.version.outputs.clean_version }}.tar.gz
             cd lol-patch-notifier-${{ steps.version.outputs.clean_version }}
             
             # zipå½¢å¼
             wget https://github.com/yuu1111/LoL-PatchNote-Notifier/releases/download/${{ steps.version.outputs.version }}/lol-patch-notifier-${{ steps.version.outputs.clean_version }}.zip
             unzip lol-patch-notifier-${{ steps.version.outputs.clean_version }}.zip
             cd release
             ```
          
          2. **ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
             ```bash
             npm ci --only=production
             ```
          
          3. **ç’°å¢ƒè¨­å®š**
             ```bash
             cp .env.example .env
             # .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦å¿…è¦ãªè¨­å®šã‚’è¡Œã†
             ```
          
          4. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•**
             ```bash
             npm start
             ```
          
          ### âš™ï¸ å¿…è¦ãªç’°å¢ƒå¤‰æ•°
          - `DISCORD_WEBHOOK_URL`: Discord Webhook URL
          - `GEMINI_API_KEY`: Google Gemini API ã‚­ãƒ¼
          - ãã®ä»–ã®è¨­å®šã¯ `.env.example` ã‚’å‚ç…§
          
          ### ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
          - Node.js 18.0.0 ä»¥ä¸Š
          - npm 8.0.0 ä»¥ä¸Š
          - 256MBä»¥ä¸Šã®ãƒ¡ãƒ¢ãƒª
          
          ### ğŸ”— ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - [README (English)](https://github.com/yuu1111/LoL-PatchNote-Notifier/blob/main/README.md)
          - [README (æ—¥æœ¬èª)](https://github.com/yuu1111/LoL-PatchNote-Notifier/blob/main/README-JP.md)
          
          ---
          **è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ by GitHub Actions** ğŸ¤–
        draft: false
        prerelease: false
        files: |
          lol-patch-notifier-${{ steps.version.outputs.clean_version }}.tar.gz
          lol-patch-notifier-${{ steps.version.outputs.clean_version }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  notify:
    runs-on: ubuntu-latest
    needs: build
    if: success()
    
    steps:
    - name: ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
      run: |
        echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ ${{ github.ref_name }} ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: https://github.com/yuu1111/LoL-PatchNote-Notifier/releases/tag/${{ github.ref_name }}"