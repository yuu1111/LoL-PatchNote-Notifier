# League of Legends パッチノート Discord 通知システム 詳細設計書

## 4. 詳細設計 (コードロジックの概要)

### 4.1. ディレクトリ・ファイル構成案

```
/lol_patch_notifier_ts/
├── src/
│   ├── app.ts                  # アプリケーションのエントリポイント (定期実行ロジックを含む)
│   ├── config/
│   │   └── index.ts            # 環境変数/設定の読み込みと型定義
│   ├── services/
│   │   ├── PatchScraper.ts     # パッチノートページのスクレイピングロジック
│   │   ├── DiscordNotifier.ts  # Discord Webhook 通知ロジック
│   │   └── ImageDownloader.ts  # 画像ダウンロード・保存ロジック
│   ├── utils/
│   │   ├── logger.ts           # ロギング設定とインスタンス (winston, プレーンテキスト)
│   │   ├── fileStorage.ts      # ファイルI/O (状態永続化用)
│   │   └── httpClient.ts       # HTTP リクエスト共通処理 (axios)
│   ├── types/
│   │   └── index.ts            # アプリケーション全体で利用する型定義
│   └── index.ts                # (オプション) `app.ts` をimportして起動する簡単なラッパー
├── patches/                    # パッチノートデータ永続保存ディレクトリ (`.gitignore` 対象)
│   ├── images/                 # パッチノート画像キャッシュ
│   │   ├── patch-25-15.jpg     # 例: パッチ25.15の画像
│   │   └── patch-25-16.png     # 例: パッチ25.16の画像
│   ├── patch-25-15.json        # 例: パッチ25.15の詳細データ
│   └── patch-25-16.json        # 例: パッチ25.16の詳細データ
├── .env.example                # 環境変数のサンプル (Git 管理対象)
├── .env                        # 実際の環境変数 (`.gitignore` 対象)
├── last_patch_status.json      # 最後に通知したパッチの情報をJSON形式で保存 (`.gitignore` 対象)
├── tsconfig.json               # TypeScript コンパイラ設定
├── package.json                # プロジェクト情報と依存関係
├── package-lock.json           # npmパッケージロックファイル (pnpmから変更)
├── .eslintrc.js                # ESLint 設定
├── .prettierrc                 # Prettier 設定
├── jest.config.js              # Jest 設定
└── README.md                   # プロジェクト説明書
```

### 4.2. コアロジックのコンポーネント

#### 4.2.1. `src/config/index.ts` (設定管理)

環境変数の読み込みと型安全な設定管理を担当するモジュールです。

**主な機能:**
* **環境変数ロード**: dotenvライブラリを使用して.envファイルから設定を読み込み
* **型安全性**: TypeScriptの静的型チェックによる実行時型検証
* **デフォルト値**: 必要に応じてデフォルト値を設定（例: チェック間隔90分）
* **バリデーション**: 必須設定値の検証とエラーハンドリング
* **環境別設定**: development/staging/production環境に応じた設定切り替え

**設定項目:**
* Discord Webhook URL（必須）
* パッチノートページURL（デフォルト提供）
* ログレベル設定
* HTTP リクエストタイムアウト
* リトライ回数とレート制限

#### 4.2.2. `src/utils/logger.ts` (ロギング)

Winstonを使用したプレーンテキスト形式のロギングシステムです。

**主な機能:**
* **レベル別ログ**: debug, info, warn, errorの4段階でログレベルを制御
* **プレーンテキスト出力**: 人間が読みやすい形式でログを出力
* **コンソール出力**: 開発時の即座な確認が可能
* **ファイル出力**: 本番環境でのログ永続化（オプション）
* **機密情報保護**: パスワードやトークンなどの機密情報を自動でマスク

#### 4.2.3. `src/utils/httpClient.ts` (HTTP クライアント)

Axiosを使用した共通HTTPリクエスト処理モジュールです。

**主な機能:**
* **統一インターフェース**: 全HTTPリクエストを統一された設定で実行
* **タイムアウト設定**: 設定可能なリクエストタイムアウト（デフォルト30秒）
* **リトライ機能**: 指数バックオフによる自動リトライ（最大3回）
* **エラーハンドリング**: HTTP エラーの統一的な処理とログ出力
* **レート制限**: 1時間あたり最大20リクエストの制限機能

#### 4.2.4. `src/utils/fileStorage.ts` (ファイル I/O)

Node.js標準のfs/promisesを使用したファイル操作モジュールです。

**主な機能:**
* **JSON ファイル読み書き**: パッチノートデータの永続化
* **ディレクトリ自動作成**: 必要に応じてpatchesディレクトリを作成
* **型安全性**: TypeScript型定義によるデータ検証
* **エラーハンドリング**: ファイル操作エラーの適切な処理
* **抽象化**: ファイルシステムを基本とした設計（シンプルなJSONファイル永続化）

#### 4.2.5. `src/types/index.ts` (型定義)

アプリケーション全体で使用するTypeScript型定義を集約したモジュールです。

**定義される型:**
* **PatchInfo**: パッチノートの完全な情報（タイトル、URL、本文、画像情報、タイムスタンプ）
* **LastStatus**: 最後にチェックしたパッチノートの状態管理
* **DiscordEmbed**: Discord Webhook用の埋め込みメッセージ形式
* **DiscordWebhookPayload**: Discord通知のペイロード構造
* **ImageDownloadResult**: 画像ダウンロード処理の結果

**型安全性の利点:**
* コンパイル時の型チェック
* IDEでの補完とエラー検出
* リファクタリング時の安全性確保

#### 4.2.6. `src/services/ImageDownloader.ts` (画像ダウンロード)

パッチノート画像の取得と永続保存を担当するサービスクラスです。

**主な機能:**
* **画像ダウンロード**: HTTP GETでバイナリデータを取得
* **ファイル形式判定**: URLや Content-Type から拡張子を自動判定
* **ローカル保存**: patches/images/ ディレクトリにファイル保存
* **エラーハンドリング**: ダウンロード失敗時の適切な処理
* **重複チェック**: 既存ファイルの存在確認

#### 4.2.7. `src/services/PatchScraper.ts` (スクレイピングロジック)

League of Legends公式サイトからパッチノート情報を抽出するスクレイピングサービスです。

**主な機能:**
* **HTML取得**: axios経由でパッチノート一覧ページを取得
* **情報抽出**: cheerioを使用してタイトル、URL、画像URLを抽出
* **本文取得**: 個別パッチノートページから詳細な本文コンテンツを取得
* **堅牢性**: HTML構造変更に対応する複数のフォールバックセレクタ
* **エラーハンドリング**: ネットワークエラーや解析エラーの適切な処理

#### 4.2.8. `src/services/DiscordNotifier.ts` (Discord Webhook 通知)

Discord Webhookを使用してパッチノート通知を送信するサービスクラスです。

**主な機能:**
* **Embed生成**: パッチノート情報を整形されたDiscord Embedに変換
* **Webhook送信**: 設定されたWebhook URLへHTTP POSTリクエストを送信
* **画像添付**: ローカル保存された画像をEmbedに含める機能
* **メンション機能**: @everyoneや特定ロールへの通知機能
* **エラーハンドリング**: Webhook送信失敗時の詳細なエラーログ出力

**通知内容:**
* パッチノートタイトル
* パッチノートURL
* メイン画像（キャッシュされた画像）
* 公開タイムスタンプ
* カスタムカラー（Discord紫: #581478）

#### 4.2.9. `src/app.ts` (アプリケーション本体とスケジューリング)  

アプリケーション全体のオーケストレーションを担当するメインクラスです。各サービスを統合し、定期実行ロジックを実装します。

**主な機能:**
* **サービス統合**: PatchScraperとDiscordNotifierサービスのインスタンス管理
* **初期化処理**: アプリケーション起動時の設定読み込みと状態復元
* **状態管理**: 最後にチェックしたパッチノートの情報をファイルから読み書き
* **定期チェック**: node-cronを使用したスケジュールベースの自動パッチノートチェック機能
* **変更検知**: 新しいパッチノートの検出と通知トリガー
* **エラーハンドリング**: 処理全体の例外処理とログ出力

**アプリケーションライフサイクル:**
1. **初期化**: 設定ファイルから前回チェック状態を読み込み、存在しない場合は初期値を設定
2. **起動時チェック**: アプリケーション開始時に一度パッチノートをチェック
3. **スケジューラー開始**: 定期実行スケジュールを設定（デフォルト90分間隔）
4. **定期監視**: 設定間隔でパッチノートページを監視し、新規パッチノート検出時に通知

**処理フロー:**
* **パッチノート取得**: PatchScraperサービス経由で最新パッチノート情報を取得
* **変更判定**: 取得したURLと前回保存したURLを比較して新規性を判定
* **通知実行**: 新しいパッチノートが検出された場合、DiscordNotifierで通知送信
* **状態更新**: 通知完了後、最新のURL情報と処理タイムスタンプを永続化

**起動スクリプト機能:**
アプリケーションインスタンスの作成、初期化、起動時チェック、スケジューラー開始を順次実行します。プロセス全体のエラーハンドリングを実装し、予期しないエラー時は適切なログ出力とプロセス終了を行います。

