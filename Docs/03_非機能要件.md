# League of Legends パッチノート Discord 通知システム 非機能要件書

## 3. 非機能要件 (モダンな Node.js/TS 観点)

### 3.1. 開発環境とランタイム

  * **言語:** TypeScript (最新の安定版を推奨)
  * **ランタイム:** Node.js (LTS バージョンを推奨)
  * **モジュールシステム:** ES Modules (ESM) を標準とします。

### 3.2. 主要技術スタック

**コア依存関係:**
  * **パッケージマネージャー:** `npm` (ディスク効率と高速インストール、モノレポサポート)
  * **HTTP クライアント:** `axios` または `undici` (Node.js 18+ ネイティブサポート、高性能)
  * **HTML パーサー:** `cheerio` (サーバーサイド jQuery API、軽量で高速)
  * **環境変数管理:** dotenv
  * **バリデーション:** `zod` (TypeScript ファースト、ランタイム型安全性)
  * **ロギング:** `Winston`（プレーンテキスト出力）
  * **スケジューリング:** `node-cron` + `node-schedule` (クラスタリング対応)
  * **状態永続化:** `ioredis` (Redis) または Node.js `fs/promises` (ファイル)
  * **型定義:** 最新の `@types/*` パッケージ群

**開発・品質保証:**
  * **テストフレームワーク:** `vitest` (Vite ベース、高速、ESM ネイティブ)
  * **モッキング:** `msw` (Mock Service Worker、リアルなHTTPモック)
  * **E2Eテスト:** `playwright` (複数ブラウザ、信頼性の高いテスト)
  * **パフォーマンステスト:** `autocannon` (Node.js 向け軽量ベンチマーク)

**監視・可観測性:**
  * **メトリクス:** `prom-client` (Prometheus メトリクス)
  * **ヘルスチェック:** `@godaddy/terminus` (グレースフルシャットダウン)
  * **分散トレーシング:** `@opentelemetry/api` (OpenTelemetry 標準)

### 3.3. コード品質と開発プロセス

**ビルドとトランスパイル:**
  * **ビルドツール:** `tsx` (高速 TypeScript 実行) または `tsc` + `esbuild` (高速ビルド)
  * **バンドル:** `esbuild` または `rollup` (本番ビルド最適化)
  * **型チェック:** `tsc --noEmit` (型検査のみ、並列実行対応)

**コード品質管理:**
  * **Linter:** `@typescript-eslint/eslint-plugin` + `eslint-config-prettier`
  * **セキュリティ:** `eslint-plugin-security`, `semgrep` (SAST)
  * **Formatter:** `prettier` (統一フォーマット)
  * **Import 管理:** `eslint-plugin-import`, `@typescript-eslint/consistent-type-imports`

**テスト戦略:**
  * **単体テスト:** `vitest` (カバレッジ目標: 80%以上)
  * **統合テスト:** 実際のHTTPエンドポイントを含むテスト
  * **E2Eテスト:** Discord Webhook のモック環境でのテスト
  * **パフォーマンステスト:** レスポンス時間とメモリ使用量の測定
  * **コントラクトテスト:** APIスキーマ検証 (OpenAPI 3.0)

**CI/CD パイプライン:**
```yaml
workflow:
  1. dependency-check    # 脆弱性スキャン (npm audit, Snyk)
  2. lint-and-format    # ESLint + Prettier
  3. type-check         # TypeScript 型検査
  4. unit-test          # 単体テスト + カバレッジ
  5. integration-test   # 統合テスト
  6. security-scan      # SAST/DAST (CodeQL, Semgrep)
  7. build              # 本番ビルド
  8. e2e-test          # E2Eテスト (staging)
  9. performance-test   # パフォーマンステスト
  10. deploy           # デプロイ (staging → production)
```

### 3.4. 運用とデプロイ

**実行方針:**
  * **実行間隔:** Riot Games サーバーへの負荷を考慮し、1-2時間間隔 (推奨: 90分)
  * **レート制限:** 1時間あたり最大20リクエスト、バースト制限付き
  * **タイムアウト:** HTTP リクエスト 30秒、Discord Webhook 10秒
  * **リトライ:** 指数バックオフ (1s, 2s, 4s) で最大3回

**設定管理とセキュリティ:**
  * **シークレット管理:** AWS Secrets Manager / Azure Key Vault / HashiCorp Vault
  * **環境変数検証:** `zod` によるランタイム検証と型安全性
  * **設定階層:** 環境別設定 (dev/staging/prod)
  * **暗号化:** 保存時暗号化 (AES-256) および転送時暗号化 (TLS 1.3)

**デプロイメント戦略:**

**推奨: サーバーレス (コスト効率重視)**
```yaml
AWS Lambda:
  runtime: nodejs18.x
  memory: 256MB
  timeout: 5分
  trigger: EventBridge Schedule
  storage: DynamoDB / S3
  monitoring: CloudWatch + X-Ray
```

**代替: コンテナ (制御重視)**
```yaml
Docker + Kubernetes:
  base: node:18-alpine
  resources:
    cpu: 100m
    memory: 128Mi
  replicas: 1 (singleton)
  storage: Redis / PostgreSQL
  monitoring: Prometheus + Grafana
```

**軽量: PaaS (シンプル重視)**
```yaml
Render / Fly.io:
  runtime: Node.js 18
  cron: システム組み込み
  storage: 外部Redis/PostgreSQL
  monitoring: ネイティブダッシュボード
```

### 3.5. 堅牢性と保守性

**HTML スクレイピング耐性:**
  * **セレクタ戦略:** 複数のフォールバック セレクタ (data 属性 → class → 構造)
  * **スキーマ検証:** 抽出データの構造検証 (zod スキーマ)
  * **変更検知:** HTML 構造変更の自動検知とアラート
  * **キャッシュ戦略:** 一時的な障害に対するフォールバック データ

**システム設計原則:**
  * **単一責任:** 各モジュールは明確に定義された責任を持つ
  * **依存性注入:** テスタビリティと柔軟性を確保
  * **インターフェース分離:** 外部サービスへの依存を抽象化
  * **設定外部化:** 全ての設定値を環境変数または設定ファイルで管理

**監視と可観測性:**
```yaml
メトリクス:
  - リクエスト成功率 (SLI: 99.5%)
  - レスポンス時間 (SLI: p95 < 2秒)
  - エラー率 (SLI: < 0.1%)
  - 通知配信成功率 (SLI: 99.9%)

アラート:
  - 連続失敗 (3回以上)
  - 異常なレスポンス時間 (5秒以上)
  - Discord Webhook 障害
  - HTML構造変更検知
```

**ドキュメント体系:**
  * **README.md:** 概要、セットアップ、基本操作
  * **ARCHITECTURE.md:** システム設計、コンポーネント図
  * **DEPLOYMENT.md:** デプロイメント手順、環境設定
  * **TROUBLESHOOTING.md:** 一般的な問題と解決方法
  * **API.md:** インターフェース仕様、設定項目
  * **CHANGELOG.md:** バージョン履歴、破壊的変更