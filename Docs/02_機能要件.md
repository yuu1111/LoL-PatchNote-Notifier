# League of Legends パッチノート Discord 通知システム 機能要件書

## 2. 機能要件

### 2.1. パッチノート監視と情報抽出

  * **対象ページの巡回:** 指定された LoL 公式パッチノートページを定期的に HTTP リクエストで巡回します。
  * **HTML コンテンツ取得:** ページの HTML コンテンツを非同期で取得します。
  * **最新パッチノートの抽出:** 取得した HTML から、最新のパッチノートに関する以下の情報を抽出します。
      * **タイトル:** 例: "パッチノート 25.15"
      * **URL:** 例: `https://www.leagueoflegends.com/ja-jp/news/game-updates/patch-25-15-notes/` (絶対パスとして取得)
      * **本文コンテンツ:** パッチノート詳細ページから本文を取得・保存（AI要約用）
      * **メイン画像:** パッチノートに添付されている代表画像の取得・保存
        * **画像URL抽出:** HTMLから画像URLを動的に抽出（規則性なし）
        * **画像ダウンロード:** 抽出したURLから画像ファイルをHTTP GETで取得
        * **ローカル保存:** バイナリデータとしてローカルファイルシステムに保存
        * **例:** `https://cmsassets.rgpub.io/sanity/images/dsfx7636/news_live/3ceae587d86eb690b502ec87b3d064a8b50208a5-1920x1080.jpg`

### 2.2. 新規パッチノートの検知

  * **前回の状態比較:** システムが最後に通知したパッチノートの URL を記録しておき、今回の巡回で取得した最新パッチノートの URL と比較します。
  * **通知トリガー:** 比較した URL が異なる場合、新しいパッチノートが公開されたと判断し、通知処理をトリガーします。

### 2.3. Discord 通知

  * **Webhook 送信:** 新しいパッチノートが検知された場合、事前に設定された Discord Webhook URL へ HTTP POST リクエストで通知を送信します。
  * **通知コンテンツ:**
      * **テキストメッセージ:** "新しいLeague of Legendsのパッチノートが公開されました！"
      * **Discord Embed:**
          * `title`: 抽出したパッチノートのタイトル
          * `url`: 抽出したパッチノートの URL
          * `description`: 例: "詳細はこちらからご確認ください。" (固定テキストまたは必要に応じて生成)
          * `color`: Discord Embed の色 (例: `#581478` - Discord の紫色を推奨)
          * `timestamp`: 通知時のタイムスタンプ (JST)

### 2.4. 状態の永続化

  * **URL 保存:** 最後に通知したパッチノートの URL をファイル (`last_patch_status.json` など) に保存します。
  * **本文保存:** パッチノートの本文コンテンツを個別ファイルに保存します。
    * **ファイル構造:** `patches/patch-{version}.json` (例: `patches/patch-25-15.json`)
    * **保存期限:** 削除期限なし - 一度保存したパッチノートは永続的に保持
    * **用途:** AI要約処理、履歴参照、分析用データとして活用
  * **画像キャッシュ:** パッチノートのメイン画像をバイナリファイルとしてローカルに保存します。
    * **ダウンロード処理:** HTTP GETリクエストでバイナリデータを取得
    * **ファイル形式:** 元画像の拡張子を維持 (jpg, png, webp等)
    * **ファイル構造:** `patches/images/patch-{version}.{拡張子}` (例: `patches/images/patch-25-15.jpg`)
    * **保存期限:** 削除期限なし - 画像も永続的に保持
    * **用途:** Discord通知での画像表示、ローカル閲覧、アーカイブ
  * **永続化形式:** 保存形式は JSON を推奨します。
  * **データ構造例:**
    ```json
    {
      "title": "パッチノート 25.15",
      "url": "https://www.leagueoflegends.com/ja-jp/news/game-updates/patch-25-15-notes/",
      "content": "パッチノート本文...",
      "imageUrl": "https://cmsassets.rgpub.io/sanity/images/dsfx7636/news_live/3ceae587d86eb690b502ec87b3d064a8b50208a5-1920x1080.jpg",
      "localImagePath": "patches/images/patch-25-15.jpg",
      "timestamp": "2025-01-31T10:00:00Z",
      "summary": null // AI要約用フィールド（後で更新）
    }
    ```

### 2.5. エラーハンドリングとロギング

  * **堅牢なエラー処理:** ネットワークエラー、HTTP ステータスエラー (4xx/5xx)、HTML 解析エラー、Discord Webhook 送信エラーなど、発生しうるすべてのエラーを捕捉し、適切に処理します。
  * **サーキットブレーカーパターン:** 連続する失敗に対して、システムを保護するためのサーキットブレーカー機能を実装します。
  * **リトライメカニズム:** HTTP リクエストの失敗時に、指数バックオフ（初期1秒、最大30秒）を用いて最大3回まで自動リトライします。
  * **プレーンテキストロギング:** 人間が読みやすいプレーンテキスト形式でログを出力し、デバッグとモニタリングを効率化します。
  * **メトリクス収集:** 処理時間、成功/失敗率、レスポンスタイムなどの運用メトリクスを収集します。

### 2.6. セキュリティ要件

  * **レート制限:** Riot Games サーバーへの過度なリクエストを防ぐため、適切なレート制限を実装します。
  * **Webhook検証:** Discord Webhookの応答を検証し、不正なレスポンスに対して適切に対処します。
  * **入力検証:** HTML解析時に悪意のあるコンテンツから保護するため、適切な入力検証を行います。
  * **機密情報保護:** 環境変数とシークレット管理を徹底し、ログに機密情報が出力されないよう配慮します。