# League of Legends パッチノート Discord 通知システム 機能要件書

## 2. 機能要件

### 2.1. パッチノート監視と情報抽出

  * **対象ページの巡回:** 指定された LoL 公式パッチノートページを定期的に HTTP リクエストで巡回します。
  * **HTML コンテンツ取得:** ページの HTML コンテンツを非同期で取得します。
  * **最新パッチノートの抽出:** 取得した HTML から、最新のパッチノートに関する以下の情報を抽出します。
      * **タイトル:** 例: "パッチノート 25.15"
      * **URL:** 例: `https://www.leagueoflegends.com/ja-jp/news/game-updates/patch-25-15-notes/` (絶対パスとして取得)

### 2.2. 新規パッチノートの検知

  * **前回の状態比較:** システムが最後に通知したパッチノートの URL を記録しておき、今回の巡回で取得した最新パッチノートの URL と比較します。
  * **通知トリガー:** 比較した URL が異なる場合、新しいパッチノートが公開されたと判断し、通知処理をトリガーします。

### 2.3. Discord 通知

  * **Webhook 送信:** 新しいパッチノートが検知された場合、事前に設定された Discord Webhook URL へ HTTP POST リクエストで通知を送信します。
  * **通知コンテンツ:**
      * **テキストメッセージ:** "新しいLeague of Legendsのパッチノートが公開されました！"
      * **Discord Embed:**
          * `title`: 抽出したパッチノートのタイトル
          * `url`: 抽出したパッチノートの URL
          * `description`: 例: "詳細はこちらからご確認ください。" (固定テキストまたは必要に応じて生成)
          * `color`: Discord Embed の色 (例: `#581478` - Discord の紫色を推奨)
          * `timestamp`: 通知時のタイムスタンプ (JST)

### 2.4. 状態の永続化

  * **URL 保存:** 最後に通知したパッチノートの URL をファイル (`last_patch_status.json` など) に保存します。
  * **永続化形式:** 保存形式は JSON を推奨します。

### 2.5. エラーハンドリングとロギング

  * **堅牢なエラー処理:** ネットワークエラー、HTTP ステータスエラー (4xx/5xx)、HTML 解析エラー、Discord Webhook 送信エラーなど、発生しうるすべてのエラーを捕捉し、適切に処理します。
  * **サーキットブレーカーパターン:** 連続する失敗に対して、システムを保護するためのサーキットブレーカー機能を実装します。
  * **リトライメカニズム:** HTTP リクエストの失敗時に、指数バックオフ（初期1秒、最大30秒）を用いて最大3回まで自動リトライします。
  * **構造化ロギング:** JSON形式での構造化ログを採用し、ログ分析とモニタリングを効率化します。
  * **メトリクス収集:** 処理時間、成功/失敗率、レスポンスタイムなどの運用メトリクスを収集します。

### 2.6. セキュリティ要件

  * **レート制限:** Riot Games サーバーへの過度なリクエストを防ぐため、適切なレート制限を実装します。
  * **Webhook検証:** Discord Webhookの応答を検証し、不正なレスポンスに対して適切に対処します。
  * **入力検証:** HTML解析時に悪意のあるコンテンツから保護するため、適切な入力検証を行います。
  * **機密情報保護:** 環境変数とシークレット管理を徹底し、ログに機密情報が出力されないよう配慮します。